// Voucher related models
model Voucher {
  id        String  @id @default(uuid())
  storeId   String  @map("store_id")
  requestId String? @unique @map("request_id")

  // Core voucher information
  code         String  @unique
  name         String
  description  String? // Small description
  faceValue    Float   @map("face_value") // e.g., 100$
  sellingPrice Float   @map("selling_price") // e.g., 40$
  discount     Float // Auto-calculated or set

  // Availability
  quantityTotal     Int @map("quantity_total") // Total quantity
  quantityAvailable Int @map("quantity_available") // Available quantity
  reservedQuantity  Int @default(0) @map("reserved_quantity") // Temporarily reserved during payment processing

  // Validity
  expiresAt DateTime @map("expires_at")

  // Business rules
  redemptionRules String?         @map("redemption_rules") // One text line
  category        VoucherCategory @default(OTHER)

  // Visual/UI
  image          String? // Image URL
  highlightColor String? @map("highlight_color") // Hex color code
  status         String? // e.g., "HOT DEAL", "LIMITED", "NEW"

  // Legacy/Additional fields
  giftCardId String? @map("gift_card_id")
  isVerified Boolean @default(false) @map("is_verified")
  isActive   Boolean @default(true) @map("is_active")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  store              Store                  @relation("StoreVouchers", fields: [storeId], references: [id])
  request            VoucherRequest?        @relation("ApprovedVoucher", fields: [requestId], references: [id])
  payments           Payment[]              @relation("VoucherPayments")
  purchasedInstances UserPurchasedVoucher[] @relation("PurchasedInstances")
  // giftCardMappings   VoucherGiftCardMapping[] @relation("VoucherGiftCards")

  @@index([storeId], name: "voucher_store_idx")
  @@index([category], name: "voucher_category_idx")
  @@index([isActive], name: "voucher_active_idx")
  @@map("vouchers")
}

model VoucherRequest {
  id      String @id @default(uuid())
  storeId String @map("store_id")

  // Voucher information
  voucherName        String          @map("voucher_name")
  voucherDescription String?         @map("voucher_description")
  voucherFaceValue   Float           @map("voucher_face_value")
  voucherPrice       Float           @map("voucher_price")
  voucherCode        String          @map("voucher_code")
  quantityTotal      Int             @map("quantity_total")
  expiresAt          DateTime        @map("expires_at")
  redemptionRules    String?         @map("redemption_rules")
  category           VoucherCategory @default(OTHER)
  image              String? // Image URL
  highlightColor     String?         @map("highlight_color")

  // Additional details
  additionalNotes String? @map("additional_notes")

  // Request status
  status VoucherRequestStatus @default(PENDING)

  // Admin review
  reviewedById  String?   @map("reviewed_by_id")
  reviewedAt    DateTime? @map("reviewed_at")
  adminComments String?   @map("admin_comments")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime?

  // Relations
  store           Store     @relation("StoreVoucherRequests", fields: [storeId], references: [id])
  reviewedBy      User?     @relation("AdminVoucherReviews", fields: [reviewedById], references: [id])
  approvedVoucher Voucher?  @relation("ApprovedVoucher")
  payments        Payment[]

  @@index([storeId], name: "voucher_request_store_idx")
  @@index([status], name: "voucher_request_status_idx")
  @@index([reviewedById], name: "voucher_request_reviewed_by_idx")
  @@index([category], name: "voucher_request_category_idx")
  @@map("voucher_requests")
}

// Model to track individual voucher purchases by users
model UserPurchasedVoucher {
  id        String @id @default(uuid())
  userId    String @map("user_id")
  voucherId String @map("voucher_id")
  paymentId String @unique @map("payment_id")

  // Unique instance code for this purchased voucher (represents the batch)
  instanceCode String @unique @map("instance_code")

  // QR Code URL
  qrCodeUrl String? @map("qr_code_url")

  // Purchase details
  quantity          Int   @default(1)
  quantityUsed      Int   @default(0) @map("quantity_used")
  purchasePrice     Float @map("purchase_price")
  purchaseFaceValue Float @map("purchase_face_value")
  purchaseDiscount  Float @map("purchase_discount")

  // Validity
  expiresAt DateTime @map("expires_at")

  // Redemption tracking
  status       VoucherRedemptionStatus @default(UNUSED)
  redeemedAt   DateTime?               @map("redeemed_at") // Last redemption time
  redeemedWith String?                 @map("redeemed_with")

  // Purchase position for gift card delivery
  purchasePosition Int? @map("purchase_position") // 1st, 2nd, 3rd buyer, etc.

  // Additional metadata
  notes String?

  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  user    User    @relation("UserVouchers", fields: [userId], references: [id])
  voucher Voucher @relation("PurchasedInstances", fields: [voucherId], references: [id])
  payment Payment @relation("PaymentVoucherInstance", fields: [paymentId], references: [id])
  // giftCards UserGiftCard[] @relation("VoucherGiftCards")

  @@index([userId], name: "user_voucher_user_idx")
  @@index([voucherId], name: "user_voucher_voucher_idx")
  @@index([status], name: "user_voucher_status_idx")
  @@index([expiresAt], name: "user_voucher_expires_idx")
  @@index([instanceCode], name: "user_voucher_code_idx")
  @@map("user_purchased_vouchers")
}

// Enum for voucher redemption status
enum VoucherRedemptionStatus {
  UNUSED // Purchased but not yet redeemed
  PARTIALLY_USED // Some quantity used, but not all
  USED // All quantity successfully redeemed
  EXPIRED // Passed expiration date
  REFUNDED // Payment refunded
  CANCELLED // Cancelled
}
